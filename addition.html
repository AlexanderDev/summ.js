<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <title>Addition</title>
    <style type="text/css">
        html,
        body {
            margin: 0;
            padding: 0;
            height: 100%;
            font-family: Arial, Helvetica, Sans-Serif;
            color: black;
        }
        
        .header {
            min-height: 3em;
            margin-bottom: 2em;
        }
        
        .header #wrapper {
            text-align: center;
        }
        /* Header text */
        
        .header div {
            font-size: 1.2em;
            font-weight: bold;
        }
        
        .header #wrapper div {
            display: inline-block;
            vertical-align: middle;
        }
        /* Text */
        
        .header #wrapper div:last-child {}
        /* Logo */
        
        .header #wrapper div:first-child {
            margin: 8px 30px 3px 0px;
        }
        
        .header hr {
            border: none;
            background-color: #32382C;
            height: 2px;
        }
        
        .maket {
            min-height: 100%;
            position: relative;
            width: 90%;
            max-width: 1100px;
            margin: auto;
        }
        
        #content,
        .header #wrapper {}
        
        #content {
            /*padding-top: 2%;*/
            text-align: center;
            padding-bottom: 6em;
            overflow: auto;
        }
        
        div.task span {
            font-size: 2em;
            font-weight: bold;
        }
        
        canvas {
            position:absolute;
            left:0px;
            top:0px;
        }

        div.canvas_cont {
            margin: 0 auto;
            position:relative; 
            top:2em;
        }

        .absolute{
            position:absolute; 
            left:0px;
            top:0px;
            z-index: 3;
        }

        input {
            width:15px; 
        }

        div.task {
            height: 2.5em;
        }

        div.task span {
            padding: 5px;
        }

        .error{
            color: red;
        }

        .warning{
            background-color: #ff9933
        }

    </style>
</head>

<body>
    <script type="text/javascript">
        // Геометрия
        ///////////////////////////////////////////////////////////////////////////////
        function Point(x, y) {
            return {
                x: x,
                y: y
            }
        }

        function Vector(x, y) {
            return {
                x: x,
                y: y
            }
        }

        function subtraction_vec(a, b) {
            return Vector(a.x - b.x, a.y - b.y)
        }

        function normal(vec) {
            return normalize(Vector(vec.y, -vec.x))
        }

        function len_vec(vec) {
            return Math.sqrt(vec.x * vec.x + vec.y * vec.y)
        }

        function normalize(vec) {
            l = len_vec(vec)
            return Vector(vec.x / l, vec.y / l)
        }

        function sum_vec(a, b) {
            return Vector(a.x + b.x, a.y + b.y)
        }

        function rotate_vec(vec, deg) {
            radians = to_rad(deg)
            ca = Math.cos(radians)
            sa = Math.sin(radians)
            return Vector(ca * vec.x - sa * vec.y, sa * vec.x + ca * vec.y)
        }

        function vec_scalar(vec, scalar) {
            return Vector(vec.x * scalar, vec.y * scalar)
        }

        function to_rad(deg) {
            return deg * Math.PI / 180
        }

        // Графические элементы
        ///////////////////////////////////////////////////////////////////////////////
        function draw_vec(ctx, vec, start_point) {
            end_point = sum_vec(vec, start_point)
            ctx.beginPath()
            ctx.moveTo(start_point.x, start_point.y)
            ctx.lineTo(end_point.x, end_point.y)
            ctx.lineWidth = 1.5
            // ctx.strokeStyle="red"
            ctx.stroke()
            draw_arrow(ctx, normalize(vec), end_point, 10)
        }

        function draw_arrow(ctx, direction, end_point, len) {
            left = vec_scalar(rotate_vec(direction, 160), len)
            right = vec_scalar(rotate_vec(direction, -160), len)
            ctx.save()
            ctx.beginPath()
            ctx.moveTo(end_point.x, end_point.y)
            ctx.lineTo(end_point.x + left.x, end_point.y + left.y)
            ctx.moveTo(end_point.x, end_point.y)
            ctx.lineTo(end_point.x + right.x, end_point.y + right.y)
            ctx.stroke()
            ctx.restore()
        }

        function draw_point(ctx, point, radius) {
            ctx.beginPath()
            ctx.arc(point.x, point.y, radius, 0, 2 * Math.PI, true)
            ctx.stroke()
        }

        function draw_curve(ctx, start_point, end_point, radius) {
            direction = subtraction_vec(end_point, start_point)
            radius = typeof(radius) != 'undefined' ? radius : len_vec(direction) * 0.4

            // Найти точку над отрезком
            function uppoints(ratio, height) {
                return sum_vec(sum_vec(
                    vec_scalar(normalize(direction), len_vec(direction) * ratio),
                    vec_scalar(normal(direction), height)
                ), start_point)
            }


            midpoint1 = uppoints(1 / 5.0, radius)
            midpoint2 = uppoints(4 / 5.0, radius)
            midpoint = uppoints(0.5, radius)

            draw_arrow(ctx, normalize(subtraction_vec(end_point, midpoint2)), end_point, 10)

            // draw_point(ctx, midpoint1, 2)
            // draw_point(ctx, midpoint2, 2)
            // draw_point(ctx, midpoint, 2)

            ctx.beginPath()
            ctx.moveTo(start_point.x, start_point.y)
            ctx.bezierCurveTo(midpoint1.x, midpoint1.y, midpoint2.x, midpoint2.y, end_point.x, end_point.y)
            ctx.stroke()

            return {point:midpoint, radius:radius}
        }

        function clear_ctx(ctx){
            ctx.clearRect(0, 0, ctx.canvas.clientWidth, ctx.canvas.clientHeight)
        }

        // Элементы страницы
        //////////////////////////////////////////////////////////////////////////////
        function Ruler(ctx_img, img_name, start_point, end_point, unit_px) {
            var loaded = false
            var width, height

            img = new Image()
            img.src = img_name
            img.onload = function() {
                loaded = true

                ctx_img.save()
                ctx_img.translate(0, VERTICAL_SHIFT) 
                ctx_img.drawImage(img, 0, 0)
                ctx_img.restore()

                width = img.width
                height = img.height
            }

            return {
                add_range:function(ctx, start, stop){
                    function unit2px(unit){
                        return Point(start_point.x+unit_px*unit, start_point.y)
                    }
                    ctx.save()
                    ctx.translate(0, VERTICAL_SHIFT) 

                    curve = draw_curve(ctx, unit2px(start), unit2px(stop))
                    curve.point.y += VERTICAL_SHIFT
                    ctx.restore()
                    return curve
                }
            }
        }

        //Земеняет элемент1 на элемент2
        function swap_elements(elem1, elem2){
            elem1.parentNode.replaceChild(elem2, elem1)
        }

        function extend(object)
        {
            var mixins = Array.prototype.slice.call(arguments, 1);
            for (var i = 0; i < mixins.length; ++i)
            {
                for (var prop in mixins[i])
                {
                    if (typeof object.prototype[prop] === "undefined")
                    {
                        object.prototype[prop] = mixins[i][prop];
                    }
                }
            }
        }

        function remove_child(parent){
            function allowed(element, tagname){
                return (element.nodeName == tagname.toUpperCase())
            }
            var children = parent.childNodes;
            var elements = Array.prototype.slice.call(children,0);     
            var tags = Array.prototype.slice.call(arguments, 1);
            for (var i = 0; i < tags.length; ++i)
            {
                for (var index = 0, len = elements.length; index < len; index++) {
                    if(allowed(elements[index], tags[i])){
                        elements[index].parentNode.removeChild(elements[index]);
                    }
                }
            }                     
        }


        //Примесь
        //////////////////////////////////////////////////////////////////////////////
        var Element = {
                append:function(parent){
                    parent.appendChild(this.element)
                    return this
                },
                remove:function(){
                    this.element.remove()
                },
                set_position:function(point){
                    this.element.style.left = point.x + "px"
                    this.element.style.top = point.y + "px"
                },
                set_cssclass:function(name){
                    this.element.className = (typeof(this.cssclass) != 'undefined' ? this.cssclass : '')+' '+name
                },
                onchange:function(callback){
                    var obj = this
                    this.element.onchange = function(){callback(obj)}
                },
                value:function(){
                    return this.element.value
                },
                dom:function(){
                    return this.element
                }
        }

        function Input(cssclass){
            var input = document.createElement("input")
            input.type = "text"
            input.className = cssclass

            this.cssclass = cssclass
            this.element = input
            this.onchange = function(callback){
                var obj = this
                input.onchange = function(){callback(obj)}
            }
        }
        extend(Input, Element);


        function Span(value){
            var span = document.createElement("span")
            span.textContent = value
            this.element = span
            this.set_value = function(value){
                span.textContent=value
            }
        }
        extend(Span, Element);

        function InputCheck(cssclass, right, error, success){
            input = new Input(cssclass)
            input.onchange(function(input){
                if(input.value() != right){
                    error()
                }else{
                    success()
                }   
            })
            return input
        }

        // Заглавие
        function Title(parent_class){
            span = new Span().append(document.getElementsByClassName(parent_class)[0])
            this.set = function(title){
                span.set_value(title)
            }
        }

        function Expression(){
                this.a = 0
                this.b = 0
                this.c = 0
                this.generate = function(){
                    this.a = getRandomInt(6, 9)
                    this.c = getRandomInt(11, 14)
                    this.b = this.c - this.a
                }
        }

        function getRandomInt(min, max){
            return Math.floor(Math.random() * (max - min + 1)) + min;
        }

        //Конечный автомат
        function FSM(){
                this.current_state = arguments[0]

                this.handle = function(signal){
                    next = this.current_state.jump(signal)
                    if(next != null){
                        this.current_state = next
                    }
                    return this
                }

                this.start = function(){
                    this.current_state.handler()
                }

        }

        function State(handler){
                this.transitiontable = {}
                this.handler = handler
                this.transition = function(signal, state){
                    this.transitiontable[signal] = state
                },
                this.jump = function(signal){
                    var next = this.transitiontable[signal]
                    if(next != null)
                        setTimeout(next.handler, 0);
                        return next
                }
        }


        //Вертикальное смещение обеспечивающие пространство для рисование кривых
        var VERTICAL_SHIFT = 300
        var INPUT_WIDTH = 20
        var INPUT_HEIGHT = 21

        //Main
        //////////////////////////////////////////////////////////////////////////////
        window.onload = function() {
            var title = new Title("title")
            var exp = new Expression()

            var canvas_top = document.getElementById('canvas_top')
            var canvas_bottom = document.getElementById('canvas_bottom')

            var ctx_bottom = canvas_bottom.getContext("2d")
            var ctx_top = canvas_top.getContext("2d")

            ctx_top.lineWidth = 1.7

            var ruler = Ruler(ctx_bottom, 'sprite.png', Point(35, 5), Point(815, 5), 39)

            var a_span = new Span()
            var op_span = new Span('+')
            var b_span = new Span()
            var eq_span = new Span('=')
            var c_span = new Span()

            function input_label(title_txt, expr_elem, range, signal){
                title.set(title_txt)
                curve = ruler.add_range(ctx_top, range.a, range.b)

                var label = new Span()
                input = InputCheck("curvelabel absolute", (range.b-range.a), 
                    function(){
                        input.set_cssclass('error')
                        expr_elem.set_cssclass('warning')

                        fsm.handle('error')
                    },
                    function(){
                        input.set_cssclass('')
                        expr_elem.set_cssclass('')

                        label.set_value(range.b-range.a)
                        label.set_cssclass('absolute')
                        label.set_position(curve.point)
                        swap_elements(input.dom(), label.dom())

                        fsm.handle(signal)
                    })

                input.append(document.getElementsByClassName("canvas_cont")[0])
                input.set_position(Point(curve.point.x-INPUT_WIDTH/2.0, curve.point.y-INPUT_HEIGHT/2.0+curve.radius/5.0-18))
            }

            function clear_page(){
                var parent = document.getElementsByClassName('canvas_cont')[0]
                remove_child(parent, 'span')
                remove_child(parent, 'input')

                //Clear canvas
                clear_ctx(ctx_top)
                a_span.remove()
                op_span.remove()
                b_span.remove()
                eq_span.remove()
                c_span.remove()
            }

            init = new State(function(){
                exp.generate()
                a_span.set_value(exp.a)
                b_span.set_value(exp.b)
                c_span.set_value('?')

                clear_page()

                task_element = document.getElementsByClassName("task")[0]
                a_span.append(task_element)
                op_span.append(task_element)
                b_span.append(task_element)
                eq_span.append(task_element)
                c_span.append(task_element)

                console.log('init state')
                fsm.handle('check a')

            })

            a_check_state = new State(function(){
                input_label('Введите первое число', a_span, {a:0, b:exp.a}, 'a right')
                console.log('a state')
            })

            b_check_state = new State(function(){
                input_label('Введите второе число', b_span, {a:exp.a, b:exp.c}, 'b right')
                console.log('b state')
            })

            c_check_state = new State(function(){
                title.set('Введите сумму двух чисел')
                console.log('c state')

                input = InputCheck("", exp.c, 
                    function(){
                        input.set_cssclass('error')
                        fsm.handle('error')
                    },
                    function(){
                        input.set_cssclass('')
                        fsm.handle('c right')
                    })

                swap_elements(c_span.dom(), input.dom())


            })

            error = new State(function(){
                title.set('Ошибка попробуй еще раз')
            })

            init.transition('check a', a_check_state)

            a_check_state.transition('a right', b_check_state)
            a_check_state.transition('error', error)

            b_check_state.transition('b right', c_check_state   )
            b_check_state.transition('error', error)

            c_check_state.transition('c right', init)
            c_check_state.transition('error', error)
            
            error.transition('a right', b_check_state)
            error.transition('b right', c_check_state)
            error.transition('c right', init)

            var fsm = new FSM(init, a_check_state, b_check_state, error)
            fsm.start()
        }
    </script>
    <div class="maket">
        <div class="header">
            <div id="wrapper">
                <div class="title"></div>
            </div>
            <!-- Horisontal line -->
            <hr>
        </div>
        <div id="content">
            <div class="task">
            </div>
            <div class="canvas_cont" style="width:900px; height:500px;" >
                <canvas id="canvas_top" style="z-index: 2;" width="900" height="500"></canvas>
                <canvas id="canvas_bottom" style="z-index: 1;" width="900" height="500"></canvas>
            </div>
        </div>
    </div>
</body>

</html>