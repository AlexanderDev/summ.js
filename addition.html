<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <title>Addition</title>
    <style type="text/css">
        html,
        body {
            margin: 0;
            padding: 0;
            height: 100%;
            font-family: Arial, Helvetica, Sans-Serif;
            color: black;
        }
        
        .header {
            min-height: 3em;
            margin-bottom: 2em;
        }
        
        .header #wrapper {
            text-align: center;
        }
        /* Header text */
        
        .header div {
            font-size: 1.2em;
            font-weight: bold;
        }
        
        .header #wrapper div {
            display: inline-block;
            vertical-align: middle;
        }
        /* Text */
        
        .header #wrapper div:last-child {}
        /* Logo */
        
        .header #wrapper div:first-child {
            margin: 8px 30px 3px 0px;
        }
        
        .header hr {
            border: none;
            background-color: #32382C;
            height: 2px;
        }
        
        .maket {
            min-height: 100%;
            position: relative;
            width: 90%;
            max-width: 1100px;
            margin: auto;
        }
        
        #content,
        .header #wrapper {}
        
        #content {
            /*padding-top: 2%;*/
            text-align: center;
            padding-bottom: 6em;
            overflow: auto;
        }
        
        div.task span {
            font-size: 2em;
            font-weight: bold;
        }
        
        canvas {
            position:absolute;
            left:0px;
            top:0px;
        }

        div.canvas_cont {
            margin: 0 auto;
            position:relative; 
            top:2em;
        }

        .curvelabel {
            width:15px; 
            position:absolute; 
            left:0px;
            top:0px;
            z-index: 3;
        }

        div.task span {
            padding: 5px;
        }

        .error{
            color: red;
        }

        .warning{
            background-color: #ff9933
        }

    </style>
</head>

<body>
    <script type="text/javascript">
        // Геометрия
        ///////////////////////////////////////////////////////////////////////////////
        function Point(x, y) {
            return {
                x: x,
                y: y
            }
        }

        function Vector(x, y) {
            return {
                x: x,
                y: y
            }
        }

        function subtraction_vec(a, b) {
            return Vector(a.x - b.x, a.y - b.y)
        }

        function normal(vec) {
            return normalize(Vector(vec.y, -vec.x))
        }

        function len_vec(vec) {
            return Math.sqrt(vec.x * vec.x + vec.y * vec.y)
        }

        function normalize(vec) {
            l = len_vec(vec)
            return Vector(vec.x / l, vec.y / l)
        }

        function sum_vec(a, b) {
            return Vector(a.x + b.x, a.y + b.y)
        }

        function rotate_vec(vec, deg) {
            radians = to_rad(deg)
            ca = Math.cos(radians)
            sa = Math.sin(radians)
            return Vector(ca * vec.x - sa * vec.y, sa * vec.x + ca * vec.y)
        }

        function vec_scalar(vec, scalar) {
            return Vector(vec.x * scalar, vec.y * scalar)
        }

        function to_rad(deg) {
            return deg * Math.PI / 180
        }

        // Графические элементы
        ///////////////////////////////////////////////////////////////////////////////
        function draw_vec(ctx, vec, start_point) {
            end_point = sum_vec(vec, start_point)
            ctx.beginPath()
            ctx.moveTo(start_point.x, start_point.y)
            ctx.lineTo(end_point.x, end_point.y)
            ctx.lineWidth = 1.5
            // ctx.strokeStyle="red"
            ctx.stroke()
            draw_arrow(ctx, normalize(vec), end_point, 10)
        }

        function draw_arrow(ctx, direction, end_point, len) {
            left = vec_scalar(rotate_vec(direction, 160), len)
            right = vec_scalar(rotate_vec(direction, -160), len)
            ctx.save()
            ctx.beginPath()
            ctx.moveTo(end_point.x, end_point.y)
            ctx.lineTo(end_point.x + left.x, end_point.y + left.y)
            ctx.moveTo(end_point.x, end_point.y)
            ctx.lineTo(end_point.x + right.x, end_point.y + right.y)
            ctx.stroke()
            ctx.restore()
        }

        function draw_point(ctx, point, radius) {
            ctx.beginPath()
            ctx.arc(point.x, point.y, radius, 0, 2 * Math.PI, true)
            ctx.stroke()
        }

        function draw_curve(ctx, start_point, end_point, radius) {
            direction = subtraction_vec(end_point, start_point)
            radius = typeof(radius) != 'undefined' ? radius : len_vec(direction) * 0.4

            // Найти точку над отрезком
            function uppoints(ratio, height) {
                return sum_vec(sum_vec(
                    vec_scalar(normalize(direction), len_vec(direction) * ratio),
                    vec_scalar(normal(direction), height)
                ), start_point)
            }


            midpoint1 = uppoints(1 / 5.0, radius)
            midpoint2 = uppoints(4 / 5.0, radius)
            midpoint = uppoints(0.5, radius)

            draw_arrow(ctx, normalize(subtraction_vec(end_point, midpoint2)), end_point, 10)

            // draw_point(ctx, midpoint1, 2)
            // draw_point(ctx, midpoint2, 2)
            // draw_point(ctx, midpoint, 2)

            ctx.beginPath()
            ctx.moveTo(start_point.x, start_point.y)
            ctx.bezierCurveTo(midpoint1.x, midpoint1.y, midpoint2.x, midpoint2.y, end_point.x, end_point.y)
            ctx.stroke()

            return {point:midpoint, radius:radius}
        }

        function clear_ctx(ctx){
            ctx.clearRect(0, 0, ctx.canvas.clientWidth, ctx.canvas.clientHeight)
        }

        // Элементы страницы
        ///////////////////////////////////////////////////////////////////////////////
        function Ruler(ctx_img, img_name, start_point, end_point, unit_px) {
            var loaded = false
            var width, height

            img = new Image()
            img.src = img_name
            img.onload = function() {
                loaded = true

                ctx_img.save()
                ctx_img.translate(0, VERTICAL_SHIFT) 
                ctx_img.drawImage(img, 0, 0)
                ctx_img.restore()

                width = img.width
                height = img.height
            }

            return {
                add_range:function(ctx, start, stop){
                    function unit2px(unit){
                        return Point(start_point.x+unit_px*unit, start_point.y)
                    }
                    ctx.save()
                    ctx.translate(0, VERTICAL_SHIFT) 

                    curve = draw_curve(ctx, unit2px(start), unit2px(stop))

                    ctx.restore()
                    return Point(curve.point.x-INPUT_WIDTH/2.0, curve.point.y+VERTICAL_SHIFT-INPUT_HEIGHT/2.0+curve.radius/5.0-18)
                }
            }
        }

        function Input(cssclass){
            var input = document.createElement("input")
            input.type = "text"
            input.className = cssclass 
            return {
                append:function(parent){
                    parent.appendChild(input)
                },
                remove:function(){
                    input.remove()
                },
                set_position:function(point){
                    input.style.left = point.x + "px"
                    input.style.top = point.y + "px"
                },
                set_cssclass:function(name){
                    input.className = cssclass +' '+ name
                }
            }
        }

        function Span(cssclass, value){
            var span = document.createElement("span")
            span.className = cssclass 
            span.textContent=value
            return {
                append:function(parent){
                    parent.appendChild(span)
                    return this
                },
                remove:function(){
                    span.remove()
                },
                set_value:function(value){
                    span.textContent=value
                },
                set_cssclass:function(name){
                    span.className = cssclass +' '+ name
                }
            }
        }

        function State(name, handler){
            return {
                transitiontable:{},
                handler:handler,
                name:name
                ,
                transition:function(signal, state){
                    this.transitiontable[signal] = state
                },
                jump:function(signal){
                    console.log('name:', name, 'transitiontable:', this.transitiontable)
                    next = this.transitiontable[signal]
                    if(next != null)
                        next.handler()
                        return next
                }
            }
        }

        function FSM(){
            current_state = arguments[0]
            current_state.handler()
            return {
                handle:function(signal){
                    // console.log('handle', signal)
                    // console.log(current_state.name)
                    next = current_state.jump(signal)
                    if(next != null){
                        current_state = next
                    }
                    return this
                }
            }
        }

        //Вертикальное смещение обеспечивающие пространство для рисование кривых
        var VERTICAL_SHIFT = 300
        var INPUT_WIDTH = 20
        var INPUT_HEIGHT = 21

        window.onload = function() {
            
            var canvas_top = document.getElementById('canvas_top')
            var canvas_bottom = document.getElementById('canvas_bottom')

            var ctx_bottom = canvas_bottom.getContext("2d")
            var ctx_top = canvas_top.getContext("2d")

            ctx_top.lineWidth = 1.7

            ruler = Ruler(ctx_bottom, 'sprite.png', Point(35, 5), Point(815, 5), 39)
            point = ruler.add_range(ctx_top, 0, 20)
            point2 = ruler.add_range(ctx_top, 0, 5)

            // ctx_top.clearRect(0, 0, 900, 500)

            input = Input("curvelabel")
            input.append(document.getElementsByClassName("canvas_cont")[0])
            input.set_position(point)

            input2 = Input("curvelabel")
            input2.append(document.getElementsByClassName("canvas_cont")[0])
            input2.set_position(point2)

            // clear_ctx(ctx_top)

            a = Span('', 1).append(document.getElementsByClassName("task")[0])
            Span('', '+').append(document.getElementsByClassName("task")[0])
            b = Span('', 2).append(document.getElementsByClassName("task")[0])
            Span('', '=').append(document.getElementsByClassName("task")[0])
            c = Span('', 3).append(document.getElementsByClassName("task")[0])
            b.set_value(4)

            input.set_cssclass('error')

            s1 = State('state1', function(){ console.log('state1') })
            s2 = State('state2', function(){ console.log('state2') })

            s1.transition('true', s2)
            s1.transition('false', s1)

            FSM(s1, s2).handle('true').handle('false').handle('false').handle('false')
            // ruler.add_range(ctx_top, 0, 20)
            // function Obj(arg){
            //     return {
            //         s:arg,
            //         print:function(){
            //             console.log(this.s)
            //         }
            //     }
            // }

            // obj1 = Obj('1')
            // obj1.print()
            // obj2 = Obj('2')
            // obj2.print()
            // obj1.print()

            // input.remove()

        }
    </script>
    <div class="maket">
        <div class="header">
            <div id="wrapper">
                <div>Сложите два числа</div>
            </div>
            <!-- Horisontal line -->
            <hr>
        </div>
        <div id="content">
            <div class="task">
            </div>
            <div class="canvas_cont" style="width:900px; height:500px;" >
                <!-- <input type="text" class="curvelabel" name=""> -->
                <canvas id="canvas_top" style="z-index: 2;" width="900" height="500"></canvas>
                <canvas id="canvas_bottom" style="z-index: 1;" width="900" height="500"></canvas>
            </div>
        </div>
    </div>
</body>

</html>